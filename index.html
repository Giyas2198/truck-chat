<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistik Pro - Giyas 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen flex flex-col">

    <header class="text-white p-4 sticky top-0 z-50 flex justify-between items-center glass-header">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <i data-lucide="truck" class="text-blue-400"></i> Logistics Pro
        </h1>
        <span class="text-xs opacity-75 font-mono">v2.2 Giyas 2026</span>
    </header>

    <div class="flex nav-container relative z-10">
        <button onclick="switchTab('upload')" id="tabUpload" class="flex-1 py-3 font-semibold tab-active">Upload Data</button>
        <button onclick="switchTab('history')" id="tabHistory" class="flex-1 py-3 font-semibold text-gray-400">Riwayat</button>
    </div>

    <main class="flex-grow p-4 max-w-md mx-auto w-full relative z-10">
        
        <div id="sectionUpload" class="space-y-6 mt-4">
            <div class="glass-effect rounded-3xl p-6 space-y-6">
                <div>
                    <label class="block text-sm font-bold text-blue-300 mb-2 uppercase">Nomor Surat Jalan</label>
                    <input type="text" id="noSuratJalan" placeholder="CONTOH: SJ-2026-001" 
                        class="custom-input w-full px-4 py-4 rounded-xl outline-none transition uppercase font-bold text-lg">
                </div>
                
                <div class="space-y-4" id="photoInputs"></div>

                <button id="btnSubmit" onclick="uploadData()" 
                    class="btn-powerful w-full text-white font-bold py-4 rounded-xl flex justify-center items-center gap-3 text-lg">
                    <i data-lucide="save"></i> PROSES LAPORAN
                </button>
            </div>
        </div>

        <div id="sectionHistory" class="hidden space-y-4 mt-4">
            <div class="glass-effect p-4 rounded-xl space-y-3">
                <label class="block text-sm font-bold text-blue-300">Cari Berdasarkan Tanggal</label>
                <div class="flex gap-3">
                    <input type="date" id="filterTanggal" class="custom-input flex-grow p-3 rounded-lg outline-none text-white">
                    <button onclick="searchByDate()" class="btn-powerful px-6 rounded-lg flex items-center justify-center"><i data-lucide="search"></i></button>
                </div>
            </div>
            <div id="historyResults" class="space-y-4 text-sm text-center text-gray-300 glass-effect p-6 rounded-xl italic">
                Data akan muncul di sini setelah Anda memilih tanggal.
            </div>
        </div>
    </main>

    <div id="loadingOverlay" class="fixed inset-0 bg-[#0f172a]/90 backdrop-blur-md hidden flex-col items-center justify-center z-[100] text-white p-6">
        <div class="loading-spinner w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full mb-6"></div>
        <p id="loadingStatus" class="text-xl font-bold animate-pulse">Memproses...</p>
    </div>

    <script type="module">
        // Tambahkan deleteDoc ke dalam import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDocs, collection, query, where, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhvD6j5mWKuZl2fM4AoOH15FcoqUGDejM",
            authDomain: "truck-chat-d5de0.firebaseapp.com",
            projectId: "truck-chat-d5de0",
            storageBucket: "truck-chat-d5de0.firebasestorage.app",
            messagingSenderId: "191337056448",
            appId: "1:191337056448:web:42893e12d035df2daec525"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const categories = [
            { id: 'foto_1', label: '1. Produk Akan Dimuat' },
            { id: 'foto_2', label: '2. Produk Sudah Dimuat' },
            { id: 'foto_3', label: '3. Produk Sebelum Bongkar' },
            { id: 'foto_4', label: '4. Produk Sesudah Bongkar' },
            { id: 'foto_5', label: '5. Foto Surat Jalan TTD & STAMP' }
        ];

        // Render input kamera
        const container = document.getElementById('photoInputs');
        categories.forEach(cat => {
            container.innerHTML += `
                <div class="p-3 rounded-xl border border-white/10 flex items-center justify-between gap-4 bg-white/5">
                    <div class="flex-grow">
                         <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">${cat.label}</label>
                         <div id="${cat.id}_preview" class="text-xs text-blue-300/70 italic truncate">Belum ada foto</div>
                    </div>
                    <div>
                        <input type="file" accept="image/*" capture="environment" id="${cat.id}" class="hidden" onchange="window.previewImage(this, '${cat.id}_preview')">
                        <button onclick="document.getElementById('${cat.id}').click()" class="bg-blue-600/20 border border-blue-500/30 p-3 rounded-full">
                            <i data-lucide="camera" class="text-blue-400 w-6 h-6"></i>
                        </button>
                    </div>
                </div>`;
        });
        lucide.createIcons();

        // Fungsi Watermark
        async function addWatermark(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width; canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const fontSize = canvas.width * 0.04;
                        ctx.font = `bold ${fontSize}px Arial`;
                        const now = new Date();
                        const text = `${now.toLocaleString('id-ID')} | GIYAS LOGISTICS`;
                        ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
                        ctx.fillRect(0, canvas.height - (fontSize * 2), canvas.width, fontSize * 2);
                        ctx.fillStyle = "#FFD700";
                        ctx.fillText(text, 20, canvas.height - (fontSize * 0.5));
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.7);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Fungsi Upload
        window.uploadData = async () => {
            const noSJ = document.getElementById('noSuratJalan').value.trim().toUpperCase();
            if (!noSJ) return alert('Isi Nomor Surat Jalan!');
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.replace('hidden', 'flex');

            try {
                const dateKey = new Date().toISOString().split('T')[0];
                let imageData = {};

                for (let cat of categories) {
                    const fileInput = document.getElementById(cat.id);
                    if (fileInput.files[0]) {
                        document.getElementById('loadingStatus').innerText = `Proses: ${cat.label}...`;
                        const watermarkedBlob = await addWatermark(fileInput.files[0]);
                        const compressed = await imageCompression(watermarkedBlob, { maxSizeMB: 0.15, maxWidthOrHeight: 800 });
                        
                        const base64 = await new Promise(r => {
                            const rd = new FileReader();
                            rd.onloadend = () => r(rd.result);
                            rd.readAsDataURL(compressed);
                        });
                        imageData[cat.id] = base64;
                    }
                }

                await setDoc(doc(db, "pengiriman_v2", noSJ), {
                    nomor_sj: noSJ, tanggal_indeks: dateKey, foto: imageData, waktu_simpan: serverTimestamp()
                });

                alert("Data Berhasil Disimpan!");
                location.reload();
            } catch (error) {
                alert("Gagal: " + error.message);
                overlay.classList.replace('flex', 'hidden');
            }
        };

        // Fungsi Cari & Riwayat
        window.searchByDate = async () => {
            const targetDate = document.getElementById('filterTanggal').value;
            const resultsDiv = document.getElementById('historyResults');
            if (!targetDate) return alert("Pilih tanggal!");
            resultsDiv.innerHTML = "Mencari data...";
            
            const q = query(collection(db, "pengiriman_v2"), where("tanggal_indeks", "==", targetDate));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) return resultsDiv.innerHTML = "Tidak ada data pada tanggal ini.";

            let html = "";
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const docId = docSnap.id;
                
                html += `
                    <div class="glass-effect p-4 rounded-xl text-left border-l-4 border-blue-500 mb-6 relative">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-bold text-blue-300 text-lg">${data.nomor_sj}</div>
                                <div class="text-[10px] text-gray-500 italic uppercase">Logistik Pro System</div>
                            </div>
                            <button onclick="window.deleteReport('${docId}')" class="bg-red-500/20 text-red-400 p-2 rounded-lg hover:bg-red-500 hover:text-white transition-all">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-5 gap-2 mt-2">
                            ${Object.entries(data.foto).map(([key, src]) => `
                                <div class="relative group">
                                    <img src="${src}" class="aspect-square object-cover rounded border border-white/10 shadow-md">
                                    <a href="${src}" download="${data.nomor_sj}_${key}.jpg" 
                                       class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded">
                                       <i data-lucide="download" class="text-white w-4 h-4"></i>
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                        <p class="text-[9px] text-gray-500 mt-3">* Klik gambar di atas untuk download</p>
                    </div>`;
            });
            resultsDiv.innerHTML = html;
            lucide.createIcons();
        };

        // FUNGSI HAPUS DATA
        window.deleteReport = async (id) => {
            if (confirm(`Apakah Anda yakin ingin menghapus laporan ${id}? Data tidak bisa dikembalikan.`)) {
                try {
                    await deleteDoc(doc(db, "pengiriman_v2", id));
                    alert("Laporan berhasil dihapus!");
                    searchByDate(); // Refresh list riwayat
                } catch (error) {
                    alert("Gagal menghapus: " + error.message);
                }
            }
        };

        // Tab Logic
        window.switchTab = (t) => {
            const isU = t === 'upload';
            document.getElementById('sectionUpload').classList.toggle('hidden', !isU);
            document.getElementById('sectionHistory').classList.toggle('hidden', isU);
            document.getElementById('tabUpload').className = isU ? "flex-1 py-3 font-bold tab-active" : "flex-1 py-3 font-semibold text-gray-500";
            document.getElementById('tabHistory').className = !isU ? "flex-1 py-3 font-bold tab-active" : "flex-1 py-3 font-semibold text-gray-500";
        }

        window.previewImage = (input, previewId) => {
            if (input.files[0]) {
                document.getElementById(previewId).innerHTML = `<span class="text-green-400 font-bold italic">Selesai Difoto</span>`;
            }
        }
    </script>
</body>
</html>
